<!DOCTYPE html><html lang="zh-hans"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/Personal-Blog/2.8bee379ac3150e408f97.css">@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:400;src:url(/Personal-Blog/static/merriweather-400-l-8796b7875d52e9cb9b280211e8d3f82d.woff2) format("woff2");unicode-range:U+00??,U+0131,U+0152-0153,U+02bb-02bc,U+02c6,U+02da,U+02dc,U+2000-206f,U+2074,U+20ac,U+2122,U+2191,U+2193,U+2212,U+2215,U+feff,U+fffd}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:900;src:url(/Personal-Blog/static/montserrat-900-l-5751237264c0468be0d48ad1cea75b90.woff2) format("woff2");unicode-range:U+00??,U+0131,U+0152-0153,U+02bb-02bc,U+02c6,U+02da,U+02dc,U+2000-206f,U+2074,U+20ac,U+2122,U+2191,U+2193,U+2212,U+2215,U+feff,U+fffd}body{--pink:#ffa7c4;background-color:var(--bg)}body.light{--bg:#fff;--header:var(--pink);--textNormal:#222;--textTitle:#222;--textLink:#d23669;--hr:rgba(0,0,0,0.2);--inlineCode-bg:rgba(255,229,100,0.2);--inlineCode-text:#1a1a1a}body.dark{-webkit-font-smoothing:antialiased;--bg:#282c35;--header:#fff;--textNormal:hsla(0,0%,100%,0.88);--textTitle:#fff;--textLink:var(--pink);--hr:hsla(0,0%,100%,0.2);--inlineCode-bg:#373c49;--inlineCode-text:#e6e6e6}body:lang(ar) article,body:lang(fa) article{direction:rtl}body:lang(ar) .language-text,body:lang(ar) article .translations,body:lang(ar) article pre,body:lang(fa) .language-text,body:lang(fa) article .translations,body:lang(fa) article pre{direction:ltr}body:lang(ar) .language-text,body:lang(fa) .language-text{display:inline-block}body:lang(ar) blockquote,body:lang(fa) blockquote{border-left:unset;border-right:.32813rem solid rgba(0,0,0,.9);padding-right:1.42188rem;padding-left:unset;margin-left:.75rem;margin-right:-1.75rem}body:lang(fa) article,body:lang(fa) header>h1{font-family:Vazir}body:lang(ar) article,body:lang(ar) header>h1{font-family:Cairo,sans-serif}body:lang(ko) article,body:lang(ko) header{word-break:keep-all}code[class*=language-],pre[class*=language-]{color:#fff;background:none;font-family:Consolas,Menlo,Monaco,source-code-pro,Courier New,monospace;-webkit-font-feature-settings:normal;font-feature-settings:normal;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;margin-bottom:0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{overflow:auto;padding:1.3125rem}pre[class*=language-]::selection{background:#27292a}pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:hsla(0,0%,100%,.15)}:not(pre)>code[class*=language-]{border-radius:.3em;background:var(--inlineCode-bg);color:var(--inlineCode-text);padding:.15em .2em .05em;white-space:normal}.token.attr-name{color:#addb67;font-style:italic}.token.comment{color:#809393}.token.string,.token.url{color:#addb67}.token.variable{color:#d6deeb}.token.number{color:#f78c6c}.token.builtin,.token.char,.token.constant,.token.function{color:#82aaff}.token.punctuation{color:#c792ea}.token.doctype,.token.selector{color:#c792ea;font-style:"italic"}.token.class-name{color:#ffcb8b}.token.keyword,.token.operator,.token.tag{color:#ffa7c4}.token.boolean{color:#ff5874}.token.property{color:#80cbc4}.token.namespace{color:#b2ccd6}pre[data-line]{padding:1em 0 1em 3em;position:relative}.gatsby-highlight-code-line{background-color:#022a4b;display:block;padding-right:1em;padding-left:1.25em;border-left:.25em solid #ffa7c4}.gatsby-highlight,.gatsby-highlight-code-line{margin-right:-1.3125rem;margin-left:-1.3125rem}.gatsby-highlight{margin-bottom:1.75rem;border-radius:10px;background:#011627;-webkit-overflow-scrolling:touch;overflow:auto}@media (max-width:672px){.gatsby-highlight{border-radius:0}}.gatsby-highlight pre[class*=language-]{float:left;min-width:100%}.react-toggle{touch-action:pan-x;display:inline-block;position:relative;cursor:pointer;background-color:transparent;border:0;padding:0;-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-webkit-tap-highlight-color:rgba(0,0,0,0);-webkit-tap-highlight-color:transparent}.react-toggle-screenreader-only{border:0;clip:rect(0 0 0 0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px}.react-toggle-track{width:50px;height:24px;padding:0;border-radius:30px;background-color:#0f1114;transition:all .2s ease}.react-toggle-track-check{position:absolute;width:17px;height:17px;left:5px;top:0;bottom:0;margin-top:auto;margin-bottom:auto;line-height:0;opacity:0;transition:opacity .25s ease}.react-toggle--checked .react-toggle-track-check,.react-toggle-track-x{opacity:1;transition:opacity .25s ease}.react-toggle-track-x{position:absolute;width:17px;height:17px;right:5px;top:0;bottom:0;margin-top:auto;margin-bottom:auto;line-height:0}.react-toggle--checked .react-toggle-track-x{opacity:0}.react-toggle-thumb{position:absolute;top:1px;left:1px;width:22px;height:22px;border-radius:50%;background-color:#fafafa;box-sizing:border-box;transition:all .5s cubic-bezier(.23,1,.32,1) 0ms;-webkit-transform:translateX(0);transform:translateX(0)}.react-toggle--checked .react-toggle-thumb{-webkit-transform:translateX(26px);transform:translateX(26px);border-color:#19ab27}.react-toggle--focus .react-toggle-thumb{box-shadow:0 0 2px 3px #ffa7c4}.react-toggle:active .react-toggle-thumb{box-shadow:0 0 5px 5px #ffa7c4}</style><style data-href="/Personal-Blog/component---src-templates-blog-post-js.77da55083c18bdb7fbef.css">@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:400;src:url(/Personal-Blog/static/merriweather-400-i-l-9a3ea56a5f449980432ace5972181ef6.woff2) format("woff2");unicode-range:U+00??,U+0131,U+0152-0153,U+02bb-02bc,U+02c6,U+02da,U+02dc,U+2000-206f,U+2074,U+20ac,U+2122,U+2191,U+2193,U+2212,U+2215,U+feff,U+fffd}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:700;src:url(/Personal-Blog/static/merriweather-700-l-e24e02bb044cb07539a3a6bd12348d14.woff2) format("woff2");unicode-range:U+00??,U+0131,U+0152-0153,U+02bb-02bc,U+02c6,U+02da,U+02dc,U+2000-206f,U+2074,U+20ac,U+2122,U+2191,U+2193,U+2212,U+2215,U+feff,U+fffd}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:700;src:url(/Personal-Blog/static/merriweather-700-i-l-ad085ede31afcc5585ff34869b1cd029.woff2) format("woff2");unicode-range:U+00??,U+0131,U+0152-0153,U+02bb-02bc,U+02c6,U+02da,U+02dc,U+2000-206f,U+2074,U+20ac,U+2122,U+2191,U+2193,U+2212,U+2215,U+feff,U+fffd}.formkit-form *{box-sizing:border-box}.formkit-form legend{border:none;font-size:inherit;margin-bottom:10px;padding:0;position:relative;display:table}.formkit-form fieldset{border:0;padding:.01em 0 0;margin:0;min-width:0}.formkit-form body:not(:-moz-handler-blocked) fieldset{display:table-cell}.formkit-form p{color:inherit;font-size:inherit;font-weight:inherit}.formkit-form[data-format="slide in"],.formkit-form[data-format=modal]{display:none}.formkit-form .formkit-checkboxes,.formkit-form .formkit-input,.formkit-form .formkit-select{width:100%}.formkit-form .formkit-button,.formkit-form .formkit-submit{border:0;border-radius:5px;color:#fff;cursor:pointer;display:inline-block;text-align:center;font-size:15px;font-weight:500;margin-bottom:15px;overflow:hidden;padding:0;position:relative;vertical-align:middle}.formkit-form .formkit-button:focus,.formkit-form .formkit-button:hover,.formkit-form .formkit-submit:focus,.formkit-form .formkit-submit:hover{outline:none}.formkit-form .formkit-button:focus>span,.formkit-form .formkit-button:hover>span,.formkit-form .formkit-submit:focus>span,.formkit-form .formkit-submit:hover>span{background-color:#dc658d}.formkit-form .formkit-button>span,.formkit-form .formkit-submit>span{display:block;transition:all .3s ease-in-out;padding:12px 24px}.formkit-form .formkit-input{background:#fff;font-size:15px;padding:12px;border:1px solid #e3e3e3;flex:1 0 auto;line-height:1.4;margin:0;transition:border-color .3s ease-out}.formkit-form .formkit-input:focus{outline:none;border-color:#1677be;transition:border-color .3s ease}.formkit-form .formkit-input::-webkit-input-placeholder{color:#848585}.formkit-form .formkit-input:-ms-input-placeholder{color:#848585}.formkit-form .formkit-input::-ms-input-placeholder{color:#848585}.formkit-form .formkit-input::placeholder{color:#848585}.formkit-form [data-group=dropdown]{position:relative;display:inline-block;width:100%}.formkit-form [data-group=dropdown]:before{content:"";top:calc(50% - 2.5px);right:10px;position:absolute;pointer-events:none;border-color:#4f4f4f transparent transparent;border-style:solid;border-width:6px 6px 0;height:0;width:0;z-index:999}.formkit-form [data-group=dropdown] select{height:auto;width:100%;cursor:pointer;color:#333;line-height:1.4;margin-bottom:0;-webkit-appearance:none;-moz-appearance:none;appearance:none;font-size:15px;padding:12px 25px 12px 12px;border:1px solid #e3e3e3;background:#fff}.formkit-form [data-group=dropdown] select:focus{outline:none}.formkit-form [data-group=checkboxes]{text-align:left;margin:0}.formkit-form [data-group=checkboxes] [data-group=checkbox]{margin-bottom:10px}.formkit-form [data-group=checkboxes] [data-group=checkbox] *{cursor:pointer}.formkit-form [data-group=checkboxes] [data-group=checkbox]:last-of-type{margin-bottom:0}.formkit-form [data-group=checkboxes] [data-group=checkbox] input[type=checkbox]{display:none}.formkit-form [data-group=checkboxes] [data-group=checkbox] input[type=checkbox]+label:after{content:none}.formkit-form [data-group=checkboxes] [data-group=checkbox] input[type=checkbox]:checked+label:after{border-color:#fff;content:""}.formkit-form [data-group=checkboxes] [data-group=checkbox] input[type=checkbox]:checked+label:before{background:#10bf7a;border-color:#10bf7a}.formkit-form [data-group=checkboxes] [data-group=checkbox] label{position:relative;display:inline-block;padding-left:28px}.formkit-form [data-group=checkboxes] [data-group=checkbox] label:after,.formkit-form [data-group=checkboxes] [data-group=checkbox] label:before{position:absolute;content:"";display:inline-block}.formkit-form [data-group=checkboxes] [data-group=checkbox] label:before{height:16px;width:16px;border:1px solid #e3e3e3;background:#fff;left:0;top:3px}.formkit-form [data-group=checkboxes] [data-group=checkbox] label:after{height:4px;width:8px;border-left:2px solid #4d4d4d;border-bottom:2px solid #4d4d4d;-webkit-transform:rotate(-45deg);transform:rotate(-45deg);left:4px;top:8px}.formkit-form .formkit-alert{background:#f9fafb;border:1px solid #e3e3e3;border-radius:5px;flex:1 0 auto;list-style:none;margin:25px auto;padding:12px;text-align:center;width:100%}.formkit-form .formkit-alert:empty{display:none}.formkit-form .formkit-alert-success{background:#d3fbeb;border-color:#10bf7a;color:#0c905c}.formkit-form .formkit-alert-error{background:#fde8e2;border-color:#f2643b;color:#ea4110}.formkit-form .formkit-spinner{display:flex;height:0;width:0;margin:0 auto;position:absolute;top:0;left:0;right:0;overflow:hidden;text-align:center;transition:all .3s ease-in-out}.formkit-form .formkit-spinner>div{margin:auto;width:12px;height:12px;background-color:#fff;opacity:.3;border-radius:100%;display:inline-block;-webkit-animation:formkit-bouncedelay-formkit-form-data-uid-4a352cb1fd- 1.4s ease-in-out infinite both;animation:formkit-bouncedelay-formkit-form-data-uid-4a352cb1fd- 1.4s ease-in-out infinite both}.formkit-form .formkit-spinner>div:first-child{-webkit-animation-delay:-.32s;animation-delay:-.32s}.formkit-form .formkit-spinner>div:nth-child(2){-webkit-animation-delay:-.16s;animation-delay:-.16s}.formkit-form .formkit-submit[data-active] .formkit-spinner{opacity:1;height:100%;width:50px}.formkit-form .formkit-submit[data-active] .formkit-spinner~span{opacity:0}@-webkit-keyframes formkit-bouncedelay-formkit-form-data-uid-4a352cb1fd-{0%,80%,to{-webkit-transform:scale(0);transform:scale(0)}40%{-webkit-transform:scale(1);transform:scale(1)}}@keyframes formkit-bouncedelay-formkit-form-data-uid-4a352cb1fd-{0%,80%,to{-webkit-transform:scale(0);transform:scale(0)}40%{-webkit-transform:scale(1);transform:scale(1)}}.formkit-form{box-shadow:0 2px 15px 0 rgba(210,214,220,.5);max-width:700px;overflow:hidden}.formkit-form [data-style=full]{width:100%;display:block}.formkit-form .formkit-header{margin-top:0;margin-bottom:20px;font-family:inherit}.formkit-form .formkit-subheader{margin:15px 0}.formkit-form .formkit-column{background-size:cover;background-repeat:no-repeat;background-position:50%;padding:20px}.formkit-form .formkit-column:nth-child(2){border-top:1px solid #e9ecef}.formkit-form .formkit-field{margin:0 0 15px}.formkit-form .formkit-input,.formkit-form .formkit-submit{width:100%}.formkit-form .formkit-guarantee{font-size:13px;margin:0 0 15px}.formkit-form .formkit-guarantee>p{margin:0}.formkit-form .formkit-powered-by{color:#7d7d7d;display:block;font-size:12px;margin-bottom:0;text-align:center}.formkit-form .formkit-powered-by[data-active=false]{opacity:.5}.formkit-form[min-width~="600"] [data-style=full],.formkit-form[min-width~="700"] [data-style=full],.formkit-form[min-width~="800"] [data-style=full]{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}.formkit-form[min-width~="600"] .formkit-submit,.formkit-form[min-width~="700"] .formkit-submit,.formkit-form[min-width~="800"] .formkit-submit{width:auto}.formkit-form[min-width~="600"] .formkit-column,.formkit-form[min-width~="700"] .formkit-column,.formkit-form[min-width~="800"] .formkit-column{padding:40px}.formkit-form[min-width~="600"] .formkit-column:nth-child(2),.formkit-form[min-width~="700"] .formkit-column:nth-child(2),.formkit-form[min-width~="800"] .formkit-column:nth-child(2){border-top:none}</style><meta name="generator" content="Gatsby 2.0.91"/><style type="text/css">
    .anchor {
      float: left;
      padding-right: 4px;
      margin-left: -20px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var offset = element.offsetTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="alternate" type="application/rss+xml" title="Dan Abramov&#x27;s Overreacted Blog RSS Feed" href="/Personal-Blog/rss.xml"/><link rel="shortcut icon" href="/Personal-Blog/icons/icon-48x48.png"/><link rel="manifest" href="/Personal-Blog/manifest.webmanifest"/><title data-react-helmet="true">setState如何知道该做什么？ — Personal Blog</title><meta data-react-helmet="true" name="theme-color" content="#282c35"/><meta data-react-helmet="true" name="description" content="依赖注入是非常不错的技术，如果你不必考虑的话。"/><meta data-react-helmet="true" property="og:url" content="https://overreacted.io/zh-hans/how-does-setstate-know-what-to-do/"/><meta data-react-helmet="true" property="og:title" content="setState如何知道该做什么？"/><meta data-react-helmet="true" property="og:description" content="依赖注入是非常不错的技术，如果你不必考虑的话。"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="@yufusunlu"/><meta data-react-helmet="true" name="twitter:title" content="setState如何知道该做什么？"/><meta data-react-helmet="true" name="twitter:description" content="依赖注入是非常不错的技术，如果你不必考虑的话。"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.75 'Merriweather','Georgia',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.9);font-family:'Merriweather','Georgia',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:Montserrat,sans-serif;font-weight:900;text-rendering:optimizeLegibility;font-size:2.5rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.73286rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.4427rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;letter-spacing:0.140625em;text-transform:uppercase;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.83255rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.75966rem;line-height:1.1;font-style:italic;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}ul{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;list-style:disc;}ol{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:0.85rem;line-height:1.75rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1rem;line-height:1.75rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}blockquote{margin-left:-1.75rem;margin-right:1.75rem;margin-top:0;padding-bottom:0;padding-left:1.42188rem;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1.20112rem;line-height:1.75rem;color:inherit;font-style:italic;border-left:0.32813rem solid hsla(0,0%,0%,0.9);border-left-color:inherit;opacity:0.8;}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.75rem - 1px);background:var(--hr);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.75rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}li > ul{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.75rem / 2);}code{font-size:0.85rem;line-height:1.75rem;}kbd{font-size:0.85rem;line-height:1.75rem;}samp{font-size:0.85rem;line-height:1.75rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.16667rem;padding-right:1.16667rem;padding-top:0.875rem;padding-bottom:calc(0.875rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.75rem;color:hsla(0,0%,0%,0.9);font-weight:400;}blockquote cite:before{content:"— ";}ul,ol{margin-left:0;}@media only screen and (max-width:480px){ul,ol{margin-left:1.75rem;}blockquote{margin-left:-1.3125rem;margin-right:0;padding-left:0.98438rem;}}h1,h2,h3,h4,h5,h6{margin-top:3.5rem;}a{box-shadow:0 1px 0 0 currentColor;color:var(--textLink);text-decoration:none;}a:hover,a:active{box-shadow:none;}mark,ins{background:#007acc;color:white;padding:0.10938rem 0.21875rem;text-decoration:none;}a.gatsby-resp-image-link{box-shadow:none;}a.anchor{box-shadow:none;}a.anchor svg[aria-hidden="true"]{stroke:var(--textLink);}p code{font-size:1rem;}h1 code, h2 code, h3 code, h4 code, h5 code, h6 code{font-size:inherit;}li code{font-size:1rem;}blockquote.translation{font-size:1em;}</style><link as="script" rel="preload" href="/Personal-Blog/component---src-templates-blog-post-js-5ff9d93420b5b2cefece.js"/><link as="script" rel="preload" href="/Personal-Blog/app-4c2cfdca2a1a25fe0c85.js"/><link as="script" rel="preload" href="/Personal-Blog/0-b197e8c6c7ff26484233.js"/><link as="script" rel="preload" href="/Personal-Blog/2-1e35639783e3cf8f44c8.js"/><link as="script" rel="preload" href="/Personal-Blog/1-1b550cd61a5e170131aa.js"/><link as="script" rel="preload" href="/Personal-Blog/webpack-runtime-5d7b005a53ad7d835132.js"/><link as="fetch" rel="preload" href="/Personal-Blog/static/d/762/path---zh-hans-how-does-setstate-know-what-to-do-e-36-fd8-NghLuef2SHasPdXFt72PhMOEc.json" crossorigin="use-credentials"/></head><body class="light"><script>
              (function() {
                window.__onThemeChange = function() {};
                function setTheme(newTheme) {
                  window.__theme = newTheme;
                  preferredTheme = newTheme;
                  document.body.className = newTheme;
                  window.__onThemeChange(newTheme);
                }

                var preferredTheme;
                try {
                  preferredTheme = localStorage.getItem('theme');
                } catch (err) { }

                window.__setPreferredTheme = function(newTheme) {
                  setTheme(newTheme);
                  try {
                    localStorage.setItem('theme', newTheme);
                  } catch (err) {}
                }

                var darkQuery = window.matchMedia('(prefers-color-scheme: dark)');
                darkQuery.addListener(function(e) {
                  window.__setPreferredTheme(e.matches ? 'dark' : 'light')
                });

                setTheme(preferredTheme || (darkQuery.matches ? 'dark' : 'light'));
              })();
            </script><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div style="color:var(--textNormal);background:var(--bg);transition:color 0.2s ease-out, background 0.2s ease-out;min-height:100vh"><div style="margin-left:auto;margin-right:auto;max-width:42rem;padding:2.625rem 1.3125rem"><header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2.625rem"><h3 style="font-family:Montserrat, sans-serif;margin-top:0;margin-bottom:0;height:42px;line-height:2.625rem"><a style="box-shadow:none;text-decoration:none;color:rgb(255, 167, 196)" href="/Personal-Blog/">Personal Blog</a></h3><div style="height:24px"></div></header><main><article><header><h1 style="color:var(--textTitle)">setState如何知道该做什么？</h1><p style="font-size:0.83255rem;line-height:1.75rem;display:block;margin-bottom:1.75rem;margin-top:-1.4rem">December 9, 2018<!-- --> • ☕️ 6 min read</p><div class="translations"><p style="font-size:0.9em;border:1px solid var(--hr);border-radius:0.75em;padding:0.75em;background:var(--inlineCode-bg);word-break:keep-all;font-family:system-ui, -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;,
    &quot;Roboto&quot;, &quot;Oxygen&quot;, &quot;Ubuntu&quot;, &quot;Cantarell&quot;, &quot;Fira Sans&quot;,
    &quot;Droid Sans&quot;, &quot;Helvetica Neue&quot;, sans-serif"><span><span>Translated by readers into: </span><a href="/Personal-Blog/es/how-does-setstate-know-what-to-do/">Español</a> • <a href="/Personal-Blog/fr/how-does-setstate-know-what-to-do/">Français</a> • <a href="/Personal-Blog/ja/how-does-setstate-know-what-to-do/">日本語</a> • <b>简体中文</b> • <a href="/Personal-Blog/ko/how-does-setstate-know-what-to-do/">한국어</a></span><br/><br/><a href="/Personal-Blog/how-does-setstate-know-what-to-do/">Read the original</a> • <a href="https://github.com/gaearon/overreacted.io/edit/master/src/pages/how-does-setstate-know-what-to-do/index.zh-hans.md" target="_blank" rel="noopener noreferrer">Improve this translation</a> • <a href="/Personal-Blog/zh-hans">View all translated posts</a> </p></div></header><div><p>当你在组件中调用<code class="language-text">setState</code>的时候，你认为发生了些什么？</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Button</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> clicked<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>handleClick <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> clicked<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>clicked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">Thanks</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"></span>
<span class="token plain-text">        Click me!</span>
<span class="token plain-text">      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'container'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>当然是：React根据下一个状态<code class="language-text">{clicked：true}</code>重新渲染组件，同时更新DOM以匹配返回的<code class="language-text">&lt;h1&gt;Thanks&lt;/ h1&gt;</code>元素啊。</p>
<p>看起来很直白。但是等等，是 <em>React</em>做了这些吗？还是<em>React DOM</em>？</p>
<p>更新DOM听起来像是React DOM的职责所在。但是我们调用的是<code class="language-text">this.setState()</code>，而没有调用任何来自React DOM的东西。 而且我们组件的父类<code class="language-text">React.Component</code>也是在React本身定义的。</p>
<p>所以存在于<code class="language-text">React.Component</code>内部的<code class="language-text">setState()</code>是如何更新DOM的呢？</p>
<p><strong>免责声明: 就像本博客里<a href="/Personal-Blog/why-do-react-elements-have-typeof-property/">绝大多数</a> <a href="/Personal-Blog/how-does-react-tell-a-class-from-a-function/">其他的</a> <a href="/Personal-Blog/why-do-we-write-super-props/">帖子</a>一样， 其实你不<em>需要</em>知道其中的任何知识，就可以有效地使用React。本文面向的是那些想要了解React背后原理的人。而这完全是可选的！</strong></p>
<hr>
<p>我们或许会认为：<code class="language-text">React.Component</code>类包含了DOM更新的逻辑。</p>
<p>但是如果是这样的话，<code class="language-text">this.setState()</code>又如何能在其他环境下使用呢？举个例子，React Native app中的组件也是继承自<code class="language-text">React.Component</code>。他们依然可以像我们在上面做的那样调用<code class="language-text">this.setState()</code>，而且React Native渲染的是安卓和iOS原生的界面而不是DOM。</p>
<p>你或许对React Test Renderer 或是 Shallow Renderer很熟悉。这些测试策略能让你正常渲染组件，也可以在组件内部调用<code class="language-text">this.setState()</code>。但是这两个渲染器并不与DOM相关。</p>
<p>如果你曾使用过一些渲染器像<a href="https://github.com/facebook/react/tree/master/packages/react-art" target="_blank" rel="nofollow noopener noreferrer">React ART</a>，你也许也知道在一个页面中我们是可以使用多个渲染器的。（举个例子，ART 组件在React DOM树的内部起作用。）这使得全局标志或变量无法维持。</p>
<p>因此，<strong><code class="language-text">React.Component</code>以某种未知的方式将处理状态（state）更新的任务委托给了特定平台的代码。</strong>在我们理解这些是如何发生的之前，让我们深挖一下包（packages）是如何分离的以及为什么这样分离。</p>
<hr>
<p>有一个很常见的误解就是React“引擎”是存在于<code class="language-text">react</code>包里面的。 然而事实并非如此。</p>
<p>实际上从<a href="https://reactjs.org/blog/2015/07/03/react-v0.14-beta-1.html#two-packages" target="_blank" rel="nofollow noopener noreferrer">React 0.14</a>我们将代码拆分成多个包以来，<code class="language-text">react</code>包故意只暴露一些定义组件的API。绝大多数React的<em>实现</em>都存在于“渲染器（renderers）”中。</p>
<p><code class="language-text">react-dom</code>、<code class="language-text">react-dom/server</code>、 <code class="language-text">react-native</code>、 <code class="language-text">react-test-renderer</code>、 <code class="language-text">react-art</code>都是常见的渲染器（当然你也可以<a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/README.md#practical-examples" target="_blank" rel="nofollow noopener noreferrer">创建属于你的渲染器</a>）。</p>
<p>这就是为什么不管你的目标平台是什么，<code class="language-text">react</code>包都是可用的。从<code class="language-text">react</code>包中导出的一切，比如<code class="language-text">React.Component</code>、<code class="language-text">React.createElement</code>、 <code class="language-text">React.Children</code> 和（最终的）<a href="https://reactjs.org/docs/hooks-intro.html" target="_blank" rel="nofollow noopener noreferrer">Hooks</a>，都是独立于目标平台的。无论你是运行React DOM，还是 React DOM Server,或是 React Native，你的组件都可以使用同样的方式导入和使用。</p>
<p>相比之下，渲染器包暴露的都是特定平台的API，比如说：<code class="language-text">ReactDOM.render()</code>，可以让你将React层次结构（hierarchy）挂载进一个DOM节点。每一种渲染器都提供了类似的API。理想状况下，绝大多数<em>组件</em>都不应该从渲染器中导入任何东西。只有这样，组件才会更加灵活。</p>
<p><strong>和大多数人现在想的一样，React “引擎”就是存在于各个渲染器的内部。</strong>很多渲染器包含一份同样代码的复制 —— 我们称为<a href="https://github.com/facebook/react/tree/master/packages/react-reconciler" target="_blank" rel="nofollow noopener noreferrer">“协调器”(“reconciler”)</a>。<a href="https://reactjs.org/blog/2017/12/15/improving-the-repository-infrastructure.html#migrating-to-google-closure-compiler" target="_blank" rel="nofollow noopener noreferrer">构建步骤(build step)</a>将协调器代码和渲染器代码平滑地整合成一个高度优化的捆绑包（bundle）以获得更高的性能。（代码复制通常来说不利于控制捆绑包的大小，但是绝大多数React用户同一时间只会选用一个渲染器，比如说<code class="language-text">react-dom</code>。）</p>
<p>这里要注意的是： <code class="language-text">react</code>包仅仅是让你<em>使用</em> React 的特性，但是它完全不知道这些特性是<em>如何</em>实现的。而渲染器包(<code class="language-text">react-dom</code>、<code class="language-text">react-native</code>等)提供了React特性的实现以及平台特定的逻辑。这其中的有些代码是共享的(“协调器”)，但是这就涉及到各个渲染器的实现细节了。</p>
<hr>
<p>现在我们知道为什么当我们想使用新特性时，<code class="language-text">react</code> 和 <code class="language-text">react-dom</code><em>都</em>需要被更新。举个例子，当React 16.3添加了Context API，<code class="language-text">React.createContext()</code>API会被React包暴露出来。</p>
<p>但是<code class="language-text">React.createContext()</code> 其实并没有<em>实现</em> context。因为在React DOM 和 React DOM Server 中同样一个 API 应当有不同的实现。所以<code class="language-text">createContext()</code>只返回了一些普通对象：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// 简化版代码</span>
<span class="token keyword">function</span> <span class="token function">createContext</span><span class="token punctuation">(</span>defaultValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> context <span class="token operator">=</span> <span class="token punctuation">{</span>
    _currentValue<span class="token punctuation">:</span> defaultValue<span class="token punctuation">,</span>
    Provider<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    Consumer<span class="token punctuation">:</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  context<span class="token punctuation">.</span>Provider <span class="token operator">=</span> <span class="token punctuation">{</span>
    $$<span class="token keyword">typeof</span><span class="token punctuation">:</span> Symbol<span class="token punctuation">.</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token string">'react.provider'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    _context<span class="token punctuation">:</span> context
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  context<span class="token punctuation">.</span>Consumer <span class="token operator">=</span> <span class="token punctuation">{</span>
    $$<span class="token keyword">typeof</span><span class="token punctuation">:</span> Symbol<span class="token punctuation">.</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token string">'react.context'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    _context<span class="token punctuation">:</span> context<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> context<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>当你在代码中使用 <code class="language-text">&lt;MyContext.Provider&gt;</code> 或 <code class="language-text">&lt;MyContext.Consumer&gt;</code>的时候， 是<em>渲染器</em>决定如何处理这些接口。React DOM也许用某种方式追踪context的值，但是React DOM Server用的可能是另一种不同的方式。</p>
<p><strong>所以，如果你将<code class="language-text">react</code>升级到了16.3+，但是不更新<code class="language-text">react-dom</code>，那么你就使用了一个尚不知道<code class="language-text">Provider</code> 和 <code class="language-text">Consumer</code>类型的渲染器。</strong>这就是为什么一个老版本的<code class="language-text">react-dom</code>会<a href="https://stackoverflow.com/a/49677020/458193" target="_blank" rel="nofollow noopener noreferrer">报错说这些类型是无效的</a>。</p>
<p>同样的警告也会出现在React Native中。然而不同于React DOM的是， 一个React新版本的发布并不立即“强制”发布新的 React Native 版本。他们具有独立的发布日程。 每隔几周，更新后的渲染器代码就会<a href="https://github.com/facebook/react-native/commits/master/Libraries/Renderer/oss" target="_blank" rel="nofollow noopener noreferrer">单独同步到</a>React Native仓库。这就是相比 React DOM，React Native 特性可用时间不同的原因。</p>
<hr>
<p>好吧，所以现在我们知道了<code class="language-text">react</code>包并不包含任何有趣的东西，除此之外，具体的实现也是存在于<code class="language-text">react-dom</code>，<code class="language-text">react-native</code>之类的渲染器中。但是这并没有回答我们的问题。<code class="language-text">React.Component</code>中的<code class="language-text">setState()</code>如何与正确的渲染器“对话”？</p>
<p><strong>答案是：每个渲染器都在已创建的类上设置了一个特殊的字段。</strong>这个字段叫做<code class="language-text">updater</code>。这并不是<em>你</em>要设置的的东西——而是，React DOM、React DOM Server 或 React Native在创建完你的类的实例之后会立即设置的东西：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// React DOM 内部</span>
<span class="token keyword">const</span> inst <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">YourComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
inst<span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span>
<span class="gatsby-highlight-code-line">inst<span class="token punctuation">.</span>updater <span class="token operator">=</span> ReactDOMUpdater<span class="token punctuation">;</span></span>
<span class="token comment">// React DOM Server 内部</span>
<span class="token keyword">const</span> inst <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">YourComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
inst<span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span>
<span class="gatsby-highlight-code-line">inst<span class="token punctuation">.</span>updater <span class="token operator">=</span> ReactDOMServerUpdater<span class="token punctuation">;</span></span>
<span class="token comment">// React Native 内部</span>
<span class="token keyword">const</span> inst <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">YourComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
inst<span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span>
<span class="gatsby-highlight-code-line">inst<span class="token punctuation">.</span>updater <span class="token operator">=</span> ReactNativeUpdater<span class="token punctuation">;</span></span></code></pre></div>
<p>查看<a href="https://github.com/facebook/react/blob/ce43a8cd07c355647922480977b46713bd51883e/packages/react/src/ReactBaseClasses.js#L58-L67" target="_blank" rel="nofollow noopener noreferrer"> <code class="language-text">React.Component</code>中<code class="language-text">setState</code>的实现</a>，
<code class="language-text">setState</code>所做的一切就是委托渲染器创建这个组件的实例：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// 适当简化的代码</span>
<span class="token function">setState</span><span class="token punctuation">(</span>partialState<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 使用`updater`字段回应渲染器！</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>updater<span class="token punctuation">.</span><span class="token function">enqueueSetState</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> partialState<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>React DOM Server <a href="https://github.com/facebook/react/blob/ce43a8cd07c355647922480977b46713bd51883e/packages/react-dom/src/server/ReactPartialRenderer.js#L442-L448" target="_blank" rel="nofollow noopener noreferrer">也许想</a> 忽略一个状态更新并且警告你，而React DOM 与 React Native却想要让他们协调器（reconciler）的副本<a href="https://github.com/facebook/react/blob/ce43a8cd07c355647922480977b46713bd51883e/packages/react-reconciler/src/ReactFiberClassComponent.js#L190-L207" target="_blank" rel="nofollow noopener noreferrer">处理它</a>。</p>
<p>这就是this.setState()<code class="language-text">尽管定义在React包中，却能够更新DOM的原因。它读取由React DOM设置的</code>this.updater`，让React DOM安排并处理更新。</p>
<hr>
<p>现在关于类的部分我们已经知道了，那关于Hooks的呢？</p>
<p>当人们第一次看见<a href="https://reactjs.org/docs/hooks-intro.html" target="_blank" rel="nofollow noopener noreferrer">Hooks proposal API</a>，他们可能经常会想： <code class="language-text">useState是</code>怎么 “知道要做什么”的？然后假设它比那些包含<code class="language-text">this.setState()</code>的<code class="language-text">React.Component</code>类更“神奇”。</p>
<p>但是正如我们今天所看到的，基类中<code class="language-text">setState()</code>的执行一直以来都是一种错觉。它除了将调用转发给当前的渲染器外，什么也没做。<code class="language-text">useState</code> Hook<a href="https://github.com/facebook/react/blob/ce43a8cd07c355647922480977b46713bd51883e/packages/react/src/ReactHooks.js#L55-L56" target="_blank" rel="nofollow noopener noreferrer">也是做了同样的事情</a>。</p>
<p><strong>Hooks使用了一个“dispatcher”对象，代替了<code class="language-text">updater</code>字段。</strong>当你调用<code class="language-text">React.useState()</code>、<code class="language-text">React.useEffect()</code>、 或者其他内置的Hook时，这些调用被转发给了当前的dispatcher。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// React内部(适当简化)</span>
<span class="token keyword">const</span> React <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 真实属性隐藏的比较深，看你能不能找到它！</span>
  __currentDispatcher<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

  <span class="token function">useState</span><span class="token punctuation">(</span>initialState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> React<span class="token punctuation">.</span>__currentDispatcher<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span>initialState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span>initialState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> React<span class="token punctuation">.</span>__currentDispatcher<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span>initialState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>各个渲染器会在渲染你的组件之前设置dispatcher：</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// React DOM 内部</span>
<span class="token keyword">const</span> prevDispatcher <span class="token operator">=</span> React<span class="token punctuation">.</span>__currentDispatcher<span class="token punctuation">;</span>
<span class="gatsby-highlight-code-line">React<span class="token punctuation">.</span>__currentDispatcher <span class="token operator">=</span> ReactDOMDispatcher<span class="token punctuation">;</span></span><span class="token keyword">let</span> result<span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  result <span class="token operator">=</span> <span class="token function">YourComponent</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">  <span class="token comment">// 恢复原状</span></span><span class="gatsby-highlight-code-line">  React<span class="token punctuation">.</span>__currentDispatcher <span class="token operator">=</span> prevDispatcher<span class="token punctuation">;</span></span><span class="token punctuation">}</span></code></pre></div>
<p>举个例子， React DOM Server的实现是在<a href="https://github.com/facebook/react/blob/ce43a8cd07c355647922480977b46713bd51883e/packages/react-dom/src/server/ReactPartialRendererHooks.js#L340-L354" target="_blank" rel="nofollow noopener noreferrer">这里</a>，还有就是React DOM 和 React Native共享的协调器的实现在<a href="https://github.com/facebook/react/blob/ce43a8cd07c355647922480977b46713bd51883e/packages/react-reconciler/src/ReactFiberHooks.js" target="_blank" rel="nofollow noopener noreferrer">这里</a>。</p>
<p>这就是为什么像<code class="language-text">react-dom</code>这样的渲染器需要访问那个你调用Hooks的<code class="language-text">react</code>包。否则你的组件将不会“看见”dispatcher！如果在一个组件树中存在<a href="https://github.com/facebook/react/issues/13991" target="_blank" rel="nofollow noopener noreferrer">React的多个副本</a>，也许并不会这样。但是，这总是导致了一些模糊的错误，因此Hooks会强迫你在出现问题之前解决包的重复问题。</p>
<p>在高级工具用例中，你可以在技术上覆盖dispatcher，尽管我们不鼓励这种操作。（对于<code class="language-text">__currentDispatcher</code>这个名字我撒谎了，但是你可以在React仓库中找到真实的名字。）比如说， React DevTools将会使用<a href="https://github.com/facebook/react/blob/ce43a8cd07c355647922480977b46713bd51883e/packages/react-debug-tools/src/ReactDebugHooks.js#L203-L214" target="_blank" rel="nofollow noopener noreferrer">一个专门定制的dispatcher</a>通过捕获JavaScript堆栈跟踪来观察Hooks树。<em>请勿模仿。</em></p>
<p>这也意味着Hooks本质上并没有与React绑定在一起。如果未来有更多的库想要重用同样的原生的Hooks, 理论上来说dispatcher可以移动到一个分离的包中，然后暴露成一个一等（first-class）的API，然后给它起一个不那么“吓人”的名字。但是在实践中，我们会尽量避免过早抽象，直到需要它为止。</p>
<p><code class="language-text">updater</code>字段和<code class="language-text">__currentDispatcher</code>对象都是称为<em>依赖注入</em>的通用编程原则的形式。在这两种情况下，渲染器将诸如<code class="language-text">setState</code>之类的功能的实现“注入”到通用的React包中，以使组件更具声明性。</p>
<p> 使用React时，你无需考虑这其中的原理。我们希望React用户花更多时间考虑他们的应用程序代码，而不是像依赖注入这样的抽象概念。但是如果你想知道<code class="language-text">this.setState()</code>或<code class="language-text">useState()</code>是如何知道该做什么的，我希望这篇文章会有所帮助。</p>
<hr></div><footer><p><a href="https://mobile.twitter.com/search?q=https%3A%2F%2Foverreacted.io%2Fhow-does-setstate-know-what-to-do%2F" target="_blank" rel="noopener noreferrer">Discuss on Twitter</a> • <a href="https://github.com/gaearon/overreacted.io/edit/master/src/pages/how-does-setstate-know-what-to-do/index.zh-hans.md" target="_blank" rel="noopener noreferrer">Edit on GitHub</a></p></footer></article></main><aside><div style="margin:90px 0 40px 0;font-family:system-ui, -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;,
    &quot;Roboto&quot;, &quot;Oxygen&quot;, &quot;Ubuntu&quot;, &quot;Cantarell&quot;, &quot;Fira Sans&quot;,
    &quot;Droid Sans&quot;, &quot;Helvetica Neue&quot;, sans-serif"><form action="https://app.convertkit.com/forms/812047/subscriptions" class="seva-form formkit-form" method="post" min-width="400 500 600 700 800" style="background-color:rgb(255, 255, 255);border-radius:6px"><div data-style="full"><div data-element="column" class="formkit-column" style="background-color:rgb(249, 250, 251)"><h1 class="formkit-header" data-element="header" style="color:rgb(77, 77, 77);font-size:20px;font-weight:700">Join the Newsletter</h1><div data-element="subheader" class="formkit-subheader" style="color:rgb(104, 104, 104)"><p>Subscribe to get my latest content by email.</p></div><div class="formkit-image"><svg xmlns="http://www.w3.org/2000/svg" width="46" height="46" viewBox="0 0 46 46" style="max-width:100%"><g fill="none" fill-rule="evenodd"><path fill="#DD92AB" d="M23,36 C22.813,36 22.627,35.948 22.463,35.844 L0.463,21.844 C0.159,21.651 -0.017,21.308 0.001,20.948 C0.02,20.589 0.23,20.266 0.553,20.105 L23,6 L45.447,20.105 C45.769,20.266 45.98,20.588 45.999,20.948 C46.018,21.308 45.841,21.65 45.537,21.844 L23.537,35.844 C23.373,35.948 23.187,36 23,36 Z"></path><path fill="#FFF" d="M38,37 L8,37 L8,1 C8,0.448 8.448,0 9,0 L37,0 C37.552,0 38,0.448 38,1 L38,37 Z"></path><path fill="#FFA7C4" d="M45,46 C44.916,46 44.831,45.989 44.748,45.968 L21.748,39.968 L22,33 L46,21 L46,45 C46,45.31 45.856,45.602 45.611,45.792 C45.435,45.928 45.219,46 45,46 Z"></path><path fill="#FFC3D7" d="M45,46 L1,46 C0.447,46 0,45.552 0,45 L0,21 L45.479,44.122 C45.88,44.341 46.083,44.804 45.969,45.247 C45.856,45.69 45.457,46 45,46 Z"></path><path fill="#FFA7C4" d="M19 20.414L14.293 15.707C13.902 15.316 13.902 14.684 14.293 14.293L19 9.586 20.414 11 16.414 15 20.414 19 19 20.414zM27 20.414L25.586 19 29.586 15 25.586 11 27 9.586 31.707 14.293C32.098 14.684 32.098 15.316 31.707 15.707L27 20.414z"></path></g></svg></div></div><div data-element="column" class="formkit-column"><ul class="formkit-alert formkit-alert-error" data-element="errors" data-group="alert"></ul><div data-element="fields" class="seva-fields formkit-fields"><div class="formkit-field"><input type="text" class="formkit-input" aria-label="Your first name" name="fields[first_name]" placeholder="Your first name" style="border-color:rgb(227, 227, 227);border-radius:4px;color:rgb(0, 0, 0);font-weight:400"/></div><div class="formkit-field"><input type="email" class="formkit-input" name="email_address" aria-label="Your email address" placeholder="Your email address" style="border-color:rgb(227, 227, 227);border-radius:4px;color:rgb(0, 0, 0);font-weight:400"/></div><button data-element="submit" class="formkit-submit formkit-submit" style="background-color:hsl(340, 63%, 55%);border-radius:24px;color:white;font-weight:700"><div class="formkit-spinner"></div><span>Subscribe</span></button></div><div data-element="guarantee" class="formkit-guarantee" style="color:rgb(77, 77, 77);font-size:13px;font-weight:400"><p>I won’t send you spam.</p><p>Unsubscribe at <em>any</em> time.</p></div></div></div></form></div><h3 style="font-family:Montserrat, sans-serif;margin-top:0.4375rem"><a style="box-shadow:none;text-decoration:none;color:var(--pink)" href="/Personal-Blog/">Overreacted</a></h3><div style="display:flex;margin-bottom:3.5rem"><img src="/Personal-Blog/static/profile-pic-69c77131fd248a7aaaf26fab021f469f.png" alt="Yusuf Unlu" style="margin-right:0.875rem;margin-bottom:0;height:3.5rem;border-radius:50%"/><p style="max-width:310px">Personal blog by <a href="https://mobile.twitter.com/yufusunlu">Yusuf Unlu</a>.<!-- --> <!-- -->I explain with words and code.</p></div><nav><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li></li><li></li></ul></nav></aside></div></div></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-130227707-1', 'auto', {});
      
      
      
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-blog-post-js","jsonName":"zh-hans-how-does-setstate-know-what-to-do-e36","path":"/zh-hans/how-does-setstate-know-what-to-do/"};window.dataPath="762/path---zh-hans-how-does-setstate-know-what-to-do-e-36-fd8-NghLuef2SHasPdXFt72PhMOEc";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-4c2cfdca2a1a25fe0c85.js"],"component---src-templates-blog-index-js":["/component---src-templates-blog-index-js-1d061c91bf8b4d1ed13d.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js.77da55083c18bdb7fbef.css","/component---src-templates-blog-post-js-5ff9d93420b5b2cefece.js"],"component---src-pages-404-js":["/component---src-pages-404-js.fd288bb02445d10643fa.css","/component---src-pages-404-js-b3cd5f330471999955d6.js"],"component---src-pages-confirm-js":["/component---src-pages-confirm-js.fd288bb02445d10643fa.css","/component---src-pages-confirm-js-009d25afd727cbb30f51.js"],"component---src-pages-thanks-js":["/component---src-pages-thanks-js.fd288bb02445d10643fa.css","/component---src-pages-thanks-js-8fa56c06867d62f44f13.js"],"pages-manifest":["/pages-manifest-a624c3b1fe19cb700e23.js"]};/*]]>*/</script><script src="/Personal-Blog/webpack-runtime-5d7b005a53ad7d835132.js" async=""></script><script src="/Personal-Blog/1-1b550cd61a5e170131aa.js" async=""></script><script src="/Personal-Blog/2-1e35639783e3cf8f44c8.js" async=""></script><script src="/Personal-Blog/0-b197e8c6c7ff26484233.js" async=""></script><script src="/Personal-Blog/app-4c2cfdca2a1a25fe0c85.js" async=""></script><script src="/Personal-Blog/component---src-templates-blog-post-js-5ff9d93420b5b2cefece.js" async=""></script></body></html>